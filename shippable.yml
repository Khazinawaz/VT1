resources:
  - name: sampleNode
    type: gitRepo
    repoPath: deepikasl/VT2
    configuration:
      integrationName: deepikaGithub
      branches:
        only: master
    initialVersion:
      sha: master
  - name: sample_image_test
    type: image
    imageName: "library/nginx"
    configuration:
      integrationName: dockerInt
      #autoPull: true
    initialVersion:
      imageTag: latest

pipelines:
  - name: pipeline1
    setup:
      runtime: onHost
    steps:
      - name: stepA
        type: bash
        triggeredBy:
          resources:
            - sampleNode 
            - sample_image_test
        execution:
          onExecute:
            - echo "executing stepA..."

      - name: stepB
        type: bash
        requires:
          integrations:
            - artifactory_int
        triggeredBy:
          steps:
            - stepA 
        execution:
          onExecute:
            - echo "executing stepB..."
            - echo "apiKey is::" $int_artifactory_int_apikey
            - echo "int url is" $int_artifactory_int_url
            - jfrog rt config default-server --url $int_artifactory_int_url --apiKey $int_artifactory_int_apikey --interactive=false
            - jfrog rt use default-server
            #- docker login -u $int_docker_registry_username -p $int_docker_registry_password $int_docker_registry_url
            - rt_ip=$(echo $int_artifactory_int_url | awk -F[/:] '{print $4}')
            - rt_port=$(echo $int_artifactory_int_url | awk -F[/:] '{print $5}')
            - echo $rt_ip
            - echo $rt_port     
            - docker pull $rt_ip:$rt_port/docker-virtual/busybox:latest
            - ls $res_sample_node_resourcePath/gitRepo
            - pushd $res_sample_node_resourcePath/gitRepo
            - docker build -t $rt_ip:$rt_port/docker-virtual/alpine:$STEP_ID -f Dockerfile .
            - docker push $rt_ip:$rt_port/docker-virtual/alpine:$STEP_ID

